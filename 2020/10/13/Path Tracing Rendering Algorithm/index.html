

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/cn/img/icon.png">
  <link rel="icon" type="image/png" href="/cn/img/icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Hooy">
  <meta name="keywords" content="">
  <title>路径追踪渲染算法 - Topos Cat</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/cn/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/androidstudio.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/cn/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/cn/css/custom_icon.css">
<link rel="stylesheet" href="/cn/cn/css/dependency_graph.css">



  <script  src="/cn/js/utils.js" ></script>
  <script  src="/cn/js/color-schema.js" ></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/cn/">&nbsp;<strong>Topos Cat</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/demo/">
                <i class="iconfont icon-shiyan"></i>
                演示
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/cn/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/cn/img/path_tracing_rendering_algorithm/path_tracing_banner.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-10-13 12:02" pubdate>
        2020年10月13日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      73
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">路径追踪渲染算法</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年8月15日 凌晨
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <h1 id="Monte-Carlo-积分方法"><a href="#Monte-Carlo-积分方法" class="headerlink" title="Monte Carlo 积分方法"></a>Monte Carlo 积分方法</h1><h2 id="重要性采样"><a href="#重要性采样" class="headerlink" title="重要性采样"></a>重要性采样</h2><p>Monte Carlo 积分方法是一种求解定积分的数值方法．假定需要计算的是下面的积分</p>
<script type="math/tex; mode=display">
I=\int_a^b f(x)dx.</script><p>先选取一个连续型随机变量 $X$，要求其概率密度函数 $p(x)$ 满足</p>
<script type="math/tex; mode=display">
\forall x\in[a,b],\quad p(x)>0.</script><p>然后令 $Y=g(X)=\frac{f(X)}{p(X)}$．注意到</p>
<script type="math/tex; mode=display">
\mathrm{E}\left[Y\right]=\mathrm{E}\left[\frac{f(X)}{p(X)}\right]=\int_{a}^{b} \frac{f\left(x\right)}{p\left(x\right)} p\left(x\right) d x=I,</script><p>我们可以将求解定积分 $I$ 的任务，直接转化为估计随机变量 $Y$ 的期望 $\mathrm{E}\left[Y\right]$.</p>
<p>估计 $\mathrm{E}\left[Y\right]$ 的一个常见做法，就是用 $Y$ 为总体进行简单随机抽样，然后以样本均值</p>
<script type="math/tex; mode=display">
\overline{Y}=\frac{1}{N}\sum_{i=1}^N Y_i</script><p>作为 $\mathrm{E}\left[Y\right]$ 的估计量．具体方案如下：</p>
<blockquote>
<p>设 $X_i\sim p(x)(i=1,2,\cdots,n)$ 是独立同分布的 $n$ 个随机变量，则 $Y_i=\frac{f(X_i)}{p(X_i)}$ 也是独立同分布的 $n$ 个随机变量．令</p>
<script type="math/tex; mode=display">
I_N=\frac{1}{N}\sum_{i=1}^N\frac{f(X_i)}{p(X_i)}=\frac{1}{N}\sum_{i=1}^N Y_i,</script><p>以 $I_N$ 作为 $\mathrm{E}\left[Y\right]=I$ 的估计量．</p>
</blockquote>
<p>统计学告诉我们：样本均值是总体期望的一致无偏估计量．这里我们可以再次证明一下这个结论．首先，$I_N$ 的期望为</p>
<script type="math/tex; mode=display">
\begin{aligned}
\mathrm{E}\left[I_{N}\right]&=\mathrm{E}\left[\frac{1}{N}\sum_{i=1}^N Y_i\right]=\frac{1}{N}\mathrm{E}\left[\sum_{i=1}^N Y\right] = \mathrm{E}\left[Y\right] =I,
\end{aligned}</script><p>这说明 $I_N$ 是无偏的．其次，当 $N\to\infty$ 时，$I_N$ 的方差</p>
<script type="math/tex; mode=display">
\begin{aligned}
\mathrm{Var}\left[I_{N}\right]&=\mathrm{Var}\left[\frac{1}{N} \sum_{i=1}^{N} Y_i\right]\\
 &=\frac{1}{N^2} \sum_{i=1}^{N} \mathrm{Var}\left[Y_i\right] \\
&=\frac{1}{N} \mathrm{Var}\left[Y\right] \to 0,
\end{aligned}</script><p>这说明 $I_N$ 是一致的．证明完毕．</p>
<p>对于一个估计量，我们总希望减小它的方差．估计量 $I_{N}$ 的方差表达式为</p>
<script type="math/tex; mode=display">
\mathrm{Var}\left[I_{N}\right]=\frac{1}{N} \mathrm{Var}\left[\frac{f(X)}{p(X)}\right].</script><p>我们清楚的是：当 $p(x)=kf(x)$ 时，也即 $p(x)=\frac{1}{I}f(x)$ 时，方差会取得最小值 $0$．但是，求出 $I$ 是不可能的，因为这正是我们 Monte Carlo 积分方法的求解目标．我们所能做的，只是让 $p(x)$ 的形态尽量与 $f(x)$ 相接近．这种削减方差的手段叫作 <strong>重要性采样</strong>（importance sampling）．$f(x)$ 取值越大的区域，对积分的贡献会越多，也就越重要，需要更多的采样．</p>
<p>如果我们简单地让 $X$ 服从 $[a,b]$ 上的均匀分布．此时估计量为</p>
<script type="math/tex; mode=display">
I_N=\frac{b-a}{N}\sum_{i=1}^Nf(X_i).</script><p>直觉上看，这就是将积分区间等分成 $N$ 段，用 $N$ 个面积为 <script type="math/tex">\frac{b-a}{N}\cdot f(X_i)</script> 的矩形来估计曲边梯形．如果我们希望在某个子区间采样数翻倍，那么这个子区间需要分成两半，将一个矩形换成宽度为 $\frac{b-a}{2N}$ 的两个矩形．推而广之就是采样概率越大的区域，单个样本的权重就越小．这也是为什么 $I_{N}$ 中要除以 $p(X_i)$ 的原因．</p>
<h2 id="多重重要性采样"><a href="#多重重要性采样" class="headerlink" title="多重重要性采样"></a>多重重要性采样</h2><p>假定需要计算的是下面的积分</p>
<script type="math/tex; mode=display">
I=\int_a^b f(x)g(x)dx,</script><p>并且已知概率密度函数 $p_X(x)$ 和 $p_Y(x)$ 分别能较好地吻合 $f(x)$ 和 $g(x)$ 的形状，即它们分别能对</p>
<script type="math/tex; mode=display">
\int_a^b f(x)dx,\,\int_a^b g(x)dx</script><p>进行较好地重要性采样，那么该如何对 $I$ 进行重要性采样呢？</p>
<p>很容易想到的一种方法是用 $p_X(x)p_Y(x)$ 进行重要性采样，但是，有些时候为总体 $Z\sim p_X(x)p_Y(x)$ 生成样本 $Z_i$ 比较困难．这时，<strong>多重重要性采样</strong>（multiple importance sampling）不失为一种好的选择．</p>
<p>设 $X_i\sim p_X(x)$，$Y_i\sim p_Y(x)$，多重重要性采样使用了如下估计量</p>
<script type="math/tex; mode=display">
I_{n_{f},n_g}=\frac{1}{n_{f}} \sum_{i=1}^{n_{f}} \frac{f\left(X_{i}\right) g\left(X_{i}\right) w_{f}\left(X_{i}\right)}{p_{X}\left(X_{i}\right)}+\frac{1}{n_{g}} \sum_{j=1}^{n_{g}} \frac{f\left(Y_{j}\right) g\left(Y_{j}\right) w_{g}\left(Y_{j}\right)}{p_{Y}\left(Y_{j}\right)},</script><p>其中 $w_f(x),w_g(x)$ 是满足 $w_f(x)+w_g(x)=1$ 的权重函数．可以验证</p>
<script type="math/tex; mode=display">
\begin{aligned}
\mathrm{E}\left[I_{n_{f},n_g}\right]&= \mathrm{E}\left[\frac{f\left(X\right) g\left(X\right) w_{f}\left(X\right)}{p_{X}\left(X\right)}\right]+\mathrm{E}\left[\frac{f\left(Y\right) g\left(Y\right) w_{g}\left(Y\right)}{p_{Y}\left(Y\right)}\right]\\
&=\int_a^b\frac{f\left(x\right) g\left(x\right) w_{f}\left(x\right)}{p_X(x)}p_X(x)dx+\int_a^b\frac{f\left(x\right) g\left(x\right) w_{g}\left(x\right)}{p_Y(x)}p_Y(x)dx\\
&=\int_a^bf\left(x\right) g\left(x\right) w_{f}\left(x\right)dx+\int_a^bf\left(x\right) g\left(x\right) w_{g}\left(x\right)dx\\
&=\int_a^bf\left(x\right) g\left(x\right) (w_{f}\left(x\right)+w_{g}\left(x\right))\:dx\\
&=\int_a^bf\left(x\right) g\left(x\right)dx,
\end{aligned}</script><p>即 <script type="math/tex">I_{n_{f},n_{g}}</script> 确实是 $I$ 的无偏估计量．实践中，常使用如下形式的启发式权重函数</p>
<script type="math/tex; mode=display">
w_{f}(x)=\frac{\left(n_{f} p_{X}(x)\right)^{\beta}}{\left(n_{f} p_{X}(x)\right)^{\beta}+\left(n_{g} p_{Y}(x)\right)^{\beta}},\quad w_{g}(x)=\frac{\left(n_{g} p_{Y}(x)\right)^{\beta}}{\left(n_{f} p_{X}(x)\right)^{\beta}+\left(n_{g} p_{Y}(x)\right)^{\beta}}.</script><p>当 $\beta=2$ 时，往往效果会较好．</p>
<h1 id="光线传输方程"><a href="#光线传输方程" class="headerlink" title="光线传输方程"></a>光线传输方程</h1><h2 id="基本形式"><a href="#基本形式" class="headerlink" title="基本形式"></a>基本形式</h2><p>之前我们已经见过了反射方程</p>
<script type="math/tex; mode=display">
L_o(\mathbf{p},\boldsymbol{\omega}_o)=\int_{H^2}f_{\mathrm{r}}\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)L_i(\mathbf{p},\boldsymbol{\omega}_i)\cos\theta_i\:d\Omega_i.</script><p>如果我们将描述表面反射的双向反射分布函数 $f_{\mathrm{r}}\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)$ 替换为双向散射分布函数 $f\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)$，并加入自发光辐照率 $L_e(\mathbf{p},\boldsymbol{\omega}_o)$，那么就得到了如下含自发光项的散射方程</p>
<script type="math/tex; mode=display">
L_o(\mathbf{p},\boldsymbol{\omega}_o)=L_e(\mathbf{p},\boldsymbol{\omega}_o)+\int_{S^2}f\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)L_i(\mathbf{p},\boldsymbol{\omega}_i)\left|\cos\theta_i\right|d\Omega_i.</script><p>注意到在上式中，$L_e(\mathbf{p},\boldsymbol{\omega}_o)$ 和 $f\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)$ 都是已知量．如果我们能将函数 $L_i$ 用函数 $L_o$ 表示出来，那么我们将得到一个只含 $L_o$ 的积分方程．为了实现这一点，我们需要引入 <strong>光线投射函数</strong>（ray-casting function）$t(\mathbf{p},\boldsymbol{\omega})$．假设在 $\mathbf{p}$ 点向 $\boldsymbol{\omega}$ 方向发出一条射线，射线第一次与场景中某个表面相交的位置就记作 $t(\mathbf{p},\boldsymbol{\omega})$．于是，我们得到</p>
<script type="math/tex; mode=display">
L_i(\mathbf{p},\boldsymbol{\omega}_i)=L_o(t(\mathbf{p},\boldsymbol{\omega}_i),-\boldsymbol{\omega}_i).</script><p>为了处理射线不与场景中任何表面相交的特殊情况，我们规定此时 $t(\mathbf{p},\boldsymbol{\omega})$ 取特殊值 $\Lambda$，并且对任意 $\boldsymbol{\omega}$，有 $L_o(\Lambda,\boldsymbol{\omega})=0$．</p>
<p>利用上面的关系式，并将 $L_o(\mathbf{p},\boldsymbol{\omega}_o)$ 简记为 $L(\mathbf{p},\boldsymbol{\omega}_o)$，由此导出的方程就称为 <strong>光线传输方程</strong>（light transport equation）</p>
<script type="math/tex; mode=display">
L(\mathbf{p},\boldsymbol{\omega}_o)=L_e(\mathbf{p},\boldsymbol{\omega}_o)+\int_{S^2}f\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)L(t(\mathbf{p},\boldsymbol{\omega}_i),-\boldsymbol{\omega}_i)\left|\cos\theta_i\right|d\Omega_i.</script><p>光线传输方程也叫做称渲染方程（rendering equation），它是关于函数 $L(\mathbf{p},\boldsymbol{\omega}_o)$ 的积分方程，描述了均衡状态下物体表面任意一点、沿任意方向的辐照率．实际上，我们可以也可以得到场景中任意一点、沿任意方向的辐照率，因为借助前面导出的关系式</p>
<script type="math/tex; mode=display">
L(\mathbf{p},\boldsymbol{\omega})=L(t(\mathbf{p},\boldsymbol{\omega}),-\boldsymbol{\omega}),</script><p>我们可以将场景中的辐照率转化为物体表面的辐照率． </p>
<h2 id="表面形式"><a href="#表面形式" class="headerlink" title="表面形式"></a>表面形式</h2><p>在上面的光线传输方程中，场景中物体表面的几何信息全部隐藏在了光线投射函数 $t(\mathbf{p},\boldsymbol{\omega})$ 里．为了让这些信息显式地表达出来，我们将导出表面形式的光线传输方程．</p>
<p>之前在对某点各个方向上的入射光做积分时，我们是在单位球上做积分．考虑到某点接收的入射光实际上来自于其他物体表面各点的出射光，我们也可以把单位球上的积分转化为其他物体表面上的积分．如果我们要用蒙特卡洛积分法估计该积分，那么我们的采样区域将从单位球转到其他物体的表面．</p>
<p>下面引入一些记号．如果从 $\mathbf{p}^\prime$ 点沿 $\boldsymbol{\omega}$ 方向出发的射线经过了 $\mathbf{p}$ 点，我们记</p>
<script type="math/tex; mode=display">
L(\mathbf{p}^\prime\to\mathbf{p}):=L(\mathbf{p}^\prime,\boldsymbol{\omega})=L\left(\mathbf{p}^\prime,\frac{\mathbf{p}-\mathbf{p}^\prime}{\Vert\mathbf{p}-\mathbf{p}^\prime\Vert}\right).</script><p>如下图所示，</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="/img/path_tracing_rendering_algorithm/three_point_form.svg" srcset="/cn/img/loading.gif" width="400"> 
    <br>
    <div style="color:orange;
    font-size:14px;
    display: inline-block;
    color: #999;
    padding: 10px;">图1 - $f(\mathbf{p}^{\prime\prime}\to\mathbf{p}^\prime\to\mathbf{p})$ 示意图</div>
</center>

<p>如果 $t(\mathbf{p}^\prime,\boldsymbol{\omega}_o)=\mathbf{p}$，$t(\mathbf{p}^\prime,\boldsymbol{\omega}_i)=\mathbf{p}^{\prime\prime}$，我们记</p>
<script type="math/tex; mode=display">
f(\mathbf{p}^{\prime\prime}\to\mathbf{p}^\prime\to\mathbf{p}):=f\left(\mathbf{p}, \boldsymbol{\omega}_o, \boldsymbol{\omega}_i\right)=f\left(\mathbf{p}^\prime,\frac{\mathbf{p}-\mathbf{p}^\prime}{\Vert\mathbf{p}-\mathbf{p}^\prime\Vert},\frac{\mathbf{p}^{\prime\prime}-\mathbf{p}^\prime}{\Vert\mathbf{p}^{\prime\prime}-\mathbf{p}^\prime\Vert}\right).</script><p>设 $V\left(\mathbf{p} \leftrightarrow \mathbf{p}^{\prime}\right)$ 是可视性函数，当 $\mathbf{p}$ 与 $\mathbf{p}^{\prime}$ 两点之间没有遮挡、相互可见时，即</p>
<script type="math/tex; mode=display">
t\left(\mathbf{p},\frac{\mathbf{p}^\prime-\mathbf{p}}{\Vert\mathbf{p}^\prime-\mathbf{p}\Vert}\right)=\mathbf{p}^\prime,\quad
t\left(\mathbf{p}^\prime,\frac{\mathbf{p}-\mathbf{p}^\prime}{\Vert\mathbf{p}-\mathbf{p}^\prime\Vert}\right)=\mathbf{p}</script><p>时，$V\left(\mathbf{p} \leftrightarrow \mathbf{p}^{\prime}\right)$ 取值为 $1$；否则 $V\left(\mathbf{p} \leftrightarrow \mathbf{p}^{\prime}\right)$ 取值为 $0$．</p>
<p>设几何耦合项（geometric coupling term）为可视性函数与积分区域转换映射的 Jacobi 行列式的乘积，即</p>
<script type="math/tex; mode=display">
G\left(\mathbf{p} \leftrightarrow \mathbf{p}^{\prime}\right)=V\left(\mathbf{p} \leftrightarrow \mathbf{p}^{\prime}\right) \frac{|\cos \theta|\left|\cos \theta^{\prime}\right|}{\left\|\mathbf{p}-\mathbf{p}^{\prime}\right\|^{2}},</script><p>其中 $\theta$ 为 $\mathbf{p}$ 点处法向量与 $\mathbf{p}^\prime-\mathbf{p}$ 的夹角， $\theta^\prime$ 为 $\mathbf{p}^\prime$ 点处法向量与 $\mathbf{p}-\mathbf{p}^\prime$ 的夹角．</p>
<p>当 $V\left(\mathbf{p} \leftrightarrow \mathbf{p}^{\prime}\right)=1$ 时，光线传输方程可以重写成场景中所有物体表面 $A$ 上的积分</p>
<script type="math/tex; mode=display">
L\left(\mathbf{p}^{\prime} \rightarrow \mathbf{p}\right)=L_{\mathrm{e}}\left(\mathbf{p}^{\prime} \rightarrow \mathbf{p}\right)+\int_{A} f\left(\mathbf{p}^{\prime \prime} \rightarrow \mathbf{p}^{\prime} \rightarrow \mathbf{p}\right) L\left(\mathbf{p}^{\prime \prime} \rightarrow \mathbf{p}^{\prime}\right) G\left(\mathbf{p}^{\prime \prime} \leftrightarrow \mathbf{p}^{\prime}\right)\: d A\left(\mathbf{p}^{\prime \prime}\right).</script><p>这就是表面形式的光线传输方程．</p>
<h2 id="路径积分形式"><a href="#路径积分形式" class="headerlink" title="路径积分形式"></a>路径积分形式</h2><p>表面形式的光线传输方程给出了 $L\left(\mathbf{p}_{i+1} \rightarrow \mathbf{p}_i\right)$ 关于 $i$ 的递推关系</p>
<script type="math/tex; mode=display">
\begin{aligned}
&L\left(\mathbf{p}_{i+1} \rightarrow \mathbf{p}_i\right)\\
=\;&L_{\mathrm{e}}\left(\mathbf{p}_{i+1} \rightarrow \mathbf{p}_i\right)+\int_{A} f\left(\mathbf{p}_{i+2} \rightarrow \mathbf{p}_{i+1}\rightarrow \mathbf{p}_i\right) L\left(\mathbf{p}_{i+2}\rightarrow \mathbf{p}_{i+1}\right) G\left(\mathbf{p}_{i+2}\leftrightarrow \mathbf{p}_{i+1}\right)\: d A\left(\mathbf{p}_{i+2}\right).
\end{aligned}</script><p>从 <script type="math/tex">i=0</script> 出发，先将等式右边的 <script type="math/tex">L\left(\mathbf{p}_{2}\rightarrow\mathbf{p}_{1}\right)</script> 用 <script type="math/tex">L\left(\mathbf{p}_{3}\rightarrow \mathbf{p}_{2}\right)</script> 表示，再将先将等式右边的 <script type="math/tex">L\left(\mathbf{p}_{3}\rightarrow \mathbf{p}_{2}\right)</script> 用 <script type="math/tex">L\left(\mathbf{p}_{4}\rightarrow \mathbf{p}_{3}\right)</script> 表示，以此类推，最终将得到如下等式</p>
<script type="math/tex; mode=display">
\begin{aligned}
L\left(\mathbf{p}_{1} \rightarrow \mathbf{p}_{0}\right)&=L_{\mathrm{e}} \left(\mathbf{p}_{1} \rightarrow \mathbf{p}_{0}\right) \\
&\quad+\int_{A} L_{\mathrm{e}}\left(\mathbf{p}_{2} \rightarrow \mathbf{p}_{1}\right) f\left(\mathbf{p}_{2} \rightarrow \mathbf{p}_{1} \rightarrow \mathbf{p}_{0}\right) G\left(\mathbf{p}_{2} \leftrightarrow \mathbf{p}_{1}\right)\: d A\left(\mathbf{p}_{2}\right) \\
&\quad+\int_{A} \int_{A} L_{\mathrm{e}}\left(\mathbf{p}_{3} \rightarrow \mathbf{p}_{2}\right) f\left(\mathbf{p}_{3} \rightarrow \mathbf{p}_{2} \rightarrow \mathbf{p}_{1}\right) G\left(\mathbf{p}_{3} \leftrightarrow \mathbf{p}_{2}\right)\\
&\quad\quad\times f\left(\mathbf{p}_{2} \rightarrow \mathbf{p}_{1} \rightarrow \mathbf{p}_{0}\right) G\left(\mathbf{p}_{2} \leftrightarrow \mathbf{p}_{1}\right) \:d A\left(\mathbf{p}_{3}\right) d A\left(\mathbf{p}_{2}\right)\\
&\quad+\cdots
\end{aligned}</script><p>记</p>
<script type="math/tex; mode=display">
T\left(\overline{\mathbf{p}}_{n}\right):=\prod_{i=1}^{n-1} f\left(\mathbf{p}_{i+1} \rightarrow \mathbf{p}_{i} \rightarrow \mathbf{p}_{i-1}\right) G\left(\mathbf{p}_{i+1} \leftrightarrow \mathbf{p}_{i}\right)</script><p>为路径 <script type="math/tex">\overline{\mathbf{p}}_{n}=(\mathbf{p}_n,\mathbf{p}_{n-1},\cdots,\mathbf{p}_{0})</script> 的吞吐量（throughput），又令</p>
<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -5.555ex" xmlns="http://www.w3.org/2000/svg" width="63.03ex" height="8.634ex" role="img" focusable="false" viewBox="0 -1361 27859.3 3816.1" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-B-1D429" d="M32 442L123 446Q214 450 215 450H221V409Q222 409 229 413T251 423T284 436T328 446T382 450Q480 450 540 388T600 223Q600 128 539 61T361 -6H354Q292 -6 236 28L227 34V-132H296V-194H287Q269 -191 163 -191Q56 -191 38 -194H29V-132H98V113V284Q98 330 97 348T93 370T83 376Q69 380 42 380H29V442H32ZM457 224Q457 303 427 349T350 395Q282 395 235 352L227 345V104L233 97Q274 45 337 45Q383 45 420 86T457 224Z"></path><path id="MJX-1-TEX-S4-2013" d="M0 248V285H499V248H0Z"></path><path id="MJX-1-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-1-TEX-N-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-1-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1-TEX-LO-222B" d="M114 -798Q132 -824 165 -824H167Q195 -824 223 -764T275 -600T320 -391T362 -164Q365 -143 367 -133Q439 292 523 655T645 1127Q651 1145 655 1157T672 1201T699 1257T733 1306T777 1346T828 1360Q884 1360 912 1325T944 1245Q944 1220 932 1205T909 1186T887 1183Q866 1183 849 1198T832 1239Q832 1287 885 1296L882 1300Q879 1303 874 1307T866 1313Q851 1323 833 1323Q819 1323 807 1311T775 1255T736 1139T689 936T633 628Q574 293 510 -5T410 -437T355 -629Q278 -862 165 -862Q125 -862 92 -831T55 -746Q55 -711 74 -698T112 -685Q133 -685 150 -700T167 -741Q167 -789 114 -798Z"></path><path id="MJX-1-TEX-I-1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path><path id="MJX-1-TEX-N-22EF" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250ZM525 250Q525 274 542 292T585 310Q609 310 627 294T646 251Q646 226 629 208T586 190T543 207T525 250ZM972 250Q972 274 989 292T1032 310Q1056 310 1074 294T1093 251Q1093 226 1076 208T1033 190T990 207T972 250Z"></path><path id="MJX-1-TEX-S4-E152" d="M-24 327L-18 333H-1Q11 333 15 333T22 329T27 322T35 308T54 284Q115 203 225 162T441 120Q454 120 457 117T460 95V60V28Q460 8 457 4T442 0Q355 0 260 36Q75 118 -16 278L-24 292V327Z"></path><path id="MJX-1-TEX-S4-E153" d="M-10 60V95Q-10 113 -7 116T9 120Q151 120 250 171T396 284Q404 293 412 305T424 324T431 331Q433 333 451 333H468L474 327V292L466 278Q375 118 190 36Q95 0 8 0Q-5 0 -7 3T-10 24V60Z"></path><path id="MJX-1-TEX-S4-E151" d="M-10 60Q-10 104 -10 111T-5 118Q-1 120 10 120Q96 120 190 84Q375 2 466 -158L474 -172V-207L468 -213H451H447Q437 -213 434 -213T428 -209T423 -202T414 -187T396 -163Q331 -82 224 -41T9 0Q-4 0 -7 3T-10 25V60Z"></path><path id="MJX-1-TEX-S4-E150" d="M-18 -213L-24 -207V-172L-16 -158Q75 2 260 84Q334 113 415 119Q418 119 427 119T440 120Q454 120 457 117T460 98V60V25Q460 7 457 4T441 0Q308 0 193 -55T25 -205Q21 -211 18 -212T-1 -213H-18Z"></path><path id="MJX-1-TEX-S4-E154" d="M-10 0V120H410V0H-10Z"></path><path id="MJX-1-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-1-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-1-TEX-I-1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path><path id="MJX-1-TEX-N-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path><path id="MJX-1-TEX-N-2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path><path id="MJX-1-TEX-I-1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path><path id="MJX-1-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-1-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D443" xlink:href="#MJX-1-TEX-I-1D443"></use></g><g data-mml-node="mrow" transform="translate(917.7,0)"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="mover"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D429" xlink:href="#MJX-1-TEX-B-1D429"></use></g></g><g data-mml-node="mo" transform="translate(0,382)"><svg width="639" height="237" x="0" y="148" viewBox="159.8 148 639 237"><use data-c="2013" xlink:href="#MJX-1-TEX-S4-2013" transform="scale(1.917,1)"></use></svg></g></g><g data-mml-node="TeXAtom" transform="translate(672,-229.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g></g></g><g data-mml-node="mo" transform="translate(1535.3,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g><g data-mml-node="mo" transform="translate(3119.7,0)"><use data-c="3A" xlink:href="#MJX-1-TEX-N-3A"></use><use data-c="3D" xlink:href="#MJX-1-TEX-N-3D" transform="translate(278,0)"></use></g><g data-mml-node="munder" transform="translate(4453.5,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="OP"><g data-mml-node="munder"><g data-mml-node="mrow"><g data-mml-node="msub"><g data-mml-node="mo" transform="translate(0 1)"><use data-c="222B" xlink:href="#MJX-1-TEX-LO-222B"></use></g><g data-mml-node="TeXAtom" transform="translate(589,-896.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D434" xlink:href="#MJX-1-TEX-I-1D434"></use></g></g></g><g data-mml-node="msub" transform="translate(1336,0)"><g data-mml-node="mo" transform="translate(0 1)"><use data-c="222B" xlink:href="#MJX-1-TEX-LO-222B"></use></g><g data-mml-node="TeXAtom" transform="translate(589,-896.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D434" xlink:href="#MJX-1-TEX-I-1D434"></use></g></g></g><g data-mml-node="mo" transform="translate(2672,0)"><use data-c="22EF" xlink:href="#MJX-1-TEX-N-22EF"></use></g><g data-mml-node="msub" transform="translate(4010.7,0)"><g data-mml-node="mo" transform="translate(0 1)"><use data-c="222B" xlink:href="#MJX-1-TEX-LO-222B"></use></g><g data-mml-node="TeXAtom" transform="translate(589,-896.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D434" xlink:href="#MJX-1-TEX-I-1D434"></use></g></g></g></g><g data-mml-node="mo" transform="translate(0,-1321.4)"><use data-c="E152" xlink:href="#MJX-1-TEX-S4-E152"></use><use data-c="E153" xlink:href="#MJX-1-TEX-S4-E153" transform="translate(4730,0)"></use><g data-c="E156" transform="translate(2140,0)"><use data-c="E151" xlink:href="#MJX-1-TEX-S4-E151"></use><use data-c="E150" xlink:href="#MJX-1-TEX-S4-E150" transform="translate(450,0)"></use></g><svg width="1890" height="720" x="350" y="-300" viewBox="472.5 -300 1890 720"><use data-c="E154" xlink:href="#MJX-1-TEX-S4-E154" transform="scale(7.087,1)"></use></svg><svg width="1890" height="720" x="2940" y="-300" viewBox="472.5 -300 1890 720"><use data-c="E154" xlink:href="#MJX-1-TEX-S4-E154" transform="scale(7.087,1)"></use></svg></g></g></g><g data-mml-node="TeXAtom" transform="translate(1572.5,-2213.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(600,0)"><use data-c="2212" xlink:href="#MJX-1-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(1378,0)"><use data-c="31" xlink:href="#MJX-1-TEX-N-31"></use></g><g data-mml-node="mtext" transform="translate(1878,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="773.5px" font-family="serif">个</text></g></g></g><g data-mml-node="msub" transform="translate(9633.5,0)"><g data-mml-node="mi"><use data-c="1D43F" xlink:href="#MJX-1-TEX-I-1D43F"></use></g><g data-mml-node="TeXAtom" transform="translate(714,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="65" xlink:href="#MJX-1-TEX-N-65"></use></g></g></g></g><g data-mml-node="mrow" transform="translate(10878.1,0)"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D429" xlink:href="#MJX-1-TEX-B-1D429"></use></g></g><g data-mml-node="TeXAtom" transform="translate(672,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g></g></g><g data-mml-node="mo" transform="translate(1813,0)"><use data-c="2192" xlink:href="#MJX-1-TEX-N-2192"></use></g><g data-mml-node="msub" transform="translate(3090.8,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D429" xlink:href="#MJX-1-TEX-B-1D429"></use></g></g><g data-mml-node="TeXAtom" transform="translate(672,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mo" transform="translate(600,0)"><use data-c="2212" xlink:href="#MJX-1-TEX-N-2212"></use></g><g data-mml-node="mn" transform="translate(1378,0)"><use data-c="31" xlink:href="#MJX-1-TEX-N-31"></use></g></g></g><g data-mml-node="mo" transform="translate(5140.8,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g><g data-mml-node="mi" transform="translate(16407.9,0)"><use data-c="1D447" xlink:href="#MJX-1-TEX-I-1D447"></use></g><g data-mml-node="mrow" transform="translate(17278.5,0)"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="mover"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D429" xlink:href="#MJX-1-TEX-B-1D429"></use></g></g><g data-mml-node="mo" transform="translate(0,382)"><svg width="639" height="237" x="0" y="148" viewBox="159.8 148 639 237"><use data-c="2013" xlink:href="#MJX-1-TEX-S4-2013" transform="scale(1.917,1)"></use></svg></g></g><g data-mml-node="TeXAtom" transform="translate(672,-229.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g></g></g><g data-mml-node="mo" transform="translate(1535.3,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g><g data-mml-node="mstyle" transform="translate(19202.8,0)"><g data-mml-node="mspace"></g></g><g data-mml-node="mi" transform="translate(19424.8,0)"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(19944.8,0)"><use data-c="1D434" xlink:href="#MJX-1-TEX-I-1D434"></use></g><g data-mml-node="mrow" transform="translate(20861.5,0)"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D429" xlink:href="#MJX-1-TEX-B-1D429"></use></g></g><g data-mml-node="TeXAtom" transform="translate(672,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-1-TEX-N-32"></use></g></g></g><g data-mml-node="mo" transform="translate(1464.6,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g><g data-mml-node="mo" transform="translate(22881.7,0)"><use data-c="22EF" xlink:href="#MJX-1-TEX-N-22EF"></use></g><g data-mml-node="mi" transform="translate(24220.3,0)"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(24740.3,0)"><use data-c="1D434" xlink:href="#MJX-1-TEX-I-1D434"></use></g><g data-mml-node="mrow" transform="translate(25657,0)"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D429" xlink:href="#MJX-1-TEX-B-1D429"></use></g></g><g data-mml-node="TeXAtom" transform="translate(672,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g></g></g><g data-mml-node="mo" transform="translate(1535.3,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g><g data-mml-node="mo" transform="translate(27581.3,0)"><use data-c="2C" xlink:href="#MJX-1-TEX-N-2C"></use></g></g></g></svg></mjx-container>
<p>我们可以将 <script type="math/tex">L\left(\mathbf{p}_{1}\to\mathbf{p}_{0}\right)</script> 写成级数形式</p>
<script type="math/tex; mode=display">
L\left(\mathbf{p}_{1} \rightarrow \mathbf{p}_{0}\right)=\sum_{n=1}^{\infty} P\left(\overline{\mathbf{p}}_{n}\right).</script><p>这被称作路径积分形式的光线传输方程．注意到等式右端不再包含 $L$，因此，我们实际上以级数形式显式地写出了光线传输方程的解．<script type="math/tex">P\left(\overline{\mathbf{p}}_{1}\right)</script> 表示从光源直接射向照相机的光，<script type="math/tex">P\left(\overline{\mathbf{p}}_{2}\right)</script> 表示经过一次散射的直接光，<script type="math/tex">P\left(\overline{\mathbf{p}}_{3}\right),P\left(\overline{\mathbf{p}}_{4}\right),\cdots</script> 表示经过多次散射的间接光．</p>
<h1 id="路径追踪算法"><a href="#路径追踪算法" class="headerlink" title="路径追踪算法"></a>路径追踪算法</h1><p>路径追踪算法（path tracing algorithm）的目标是估计</p>
<script type="math/tex; mode=display">
L\left(\mathbf{p}_{1} \rightarrow \mathbf{p}_{0}\right)=\sum_{n=1}^{\infty} P\left(\overline{\mathbf{p}}_{n}\right).</script><p>的值．需要解决的问题有两个：第一个是如何估计无穷求和，第二个是如何估计积分项 $P\left(\overline{\mathbf{p}}_{n}\right)$．</p>
<h2 id="俄罗斯轮盘赌"><a href="#俄罗斯轮盘赌" class="headerlink" title="俄罗斯轮盘赌"></a>俄罗斯轮盘赌</h2><p>无穷求和的困难可以由所谓的俄罗斯轮盘赌（Russian roulette）解决．</p>
<p>假设我们有办法得到任意一个 <script type="math/tex">P\left(\overline{\mathbf{p}}_{n}\right)</script> 的无偏估计量 <script type="math/tex">\widehat{P}\left(\overline{\mathbf{p}}_{n}\right)</script>，那么我们可以立刻写出 <script type="math/tex">\sum\limits_{n=1}^{\infty} {P} \left(\overline{\mathbf{p}}_{n}\right)</script> 的一个无偏估计量</p>
<script type="math/tex; mode=display">
\sum_{n=1}^{\infty} \widehat{P} \left(\overline{\mathbf{p}}_{n}\right).</script><p>但问题是在现实中，我们只能获得有限项的 <script type="math/tex">\widehat{P}\left(\overline{\mathbf{p}}_{n}\right)</script>．俄罗斯轮盘赌的想法，就是以一定概率 $q$ 丢弃第 $N$ 项之后的所有项之和 <script type="math/tex">\sum\limits_{n=N}^{\infty} \widehat{P} \left(\overline{\mathbf{p}}_{n}\right)</script>．而在没有被丢弃的情况下，放大 <script type="math/tex">\sum\limits_{n=N}^{\infty} \widehat{P} \left(\overline{\mathbf{p}}_{n}\right)</script> 作为补偿．</p>
<p>对于前 $2$ 项 <script type="math/tex">P\left(\overline{\mathbf{p}}_{1}\right),P\left(\overline{\mathbf{p}}_{2}\right)</script>，我们并不采用俄罗斯轮盘赌，而是将它们直接计算出来．从第 $3$ 项开始，我们执行俄罗斯轮盘赌．设 $\eta_1$ 服从 0-1 分布，</p>
<script type="math/tex; mode=display">
\mathrm{P}(\eta_1=k) = q^{k}(1-q)^{1-k},\quad k=0,1,</script><p>当 $\eta_1$ 取 $1$ 时，我们丢弃之后的项，只取前两项之和</p>
<script type="math/tex; mode=display">
\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right),</script><p>而当 $\eta_1$ 取 $0$ 时，我们将后面的项乘上一个缩放因子 $\frac{1}{1-q}$，即得</p>
<script type="math/tex; mode=display">
\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\frac{1}{1-q}\sum_{n=3}^{\infty} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right).</script><p>结合这两种情况，我们的统计量应该写成</p>
<script type="math/tex; mode=display">
\widehat{Q}_3=\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\frac{1_{\eta_1=0}}{1-q}\sum_{n=3}^{\infty}\widehat{P}\left(\overline{\mathbf{p}}_{n}\right)</script><p>注意到</p>
<script type="math/tex; mode=display">
\mathrm{E}\left[\frac{1_{\eta_1=0}}{1-q}\right]=\frac{\mathrm{P}(\eta_1=0)}{1-q}=\frac{1-q}{1-q}=1,</script><p>我们有</p>
<script type="math/tex; mode=display">\mathrm{E}\left[
\sum_{n=1}^{\infty} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)\right]=\mathrm{E}\left[\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\frac{1_{\eta_1=0}}{1-q}\sum_{n=3}^{\infty}\widehat{P}\left(\overline{\mathbf{p}}_{n}\right)\right],</script><p>即 <script type="math/tex">\widehat{Q}_3</script> 也是 <script type="math/tex">\sum\limits_{n=1}^{\infty}{P}\left(\overline{\mathbf{p}}_{n}\right)</script> 的无偏估计量．</p>
<p>设 $\eta_2$ 与 $\eta_1$ 独立同分布，我们还可以用同样的方法继续构造出</p>
<script type="math/tex; mode=display">
\widehat{Q}_4=\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\frac{1_{\eta_1=0}}{1-q}\left(\widehat{P}\left(\overline{\mathbf{p}}_{3}\right)+\frac{1_{\eta_2=0}}{1-q}\sum_{n=4}^{\infty} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)\right).</script><p>显然，$\mathrm{E}[\widehat{Q}_4]=\mathrm{E}[\widehat{Q}_3]$，故 $\widehat{Q}_4$ 也是一个无偏估计量．</p>
<p>一般地，若 $\eta_1,\eta_2,\cdots$ 独立且都服从成功率为 $q$ 的 0-1 分布，则</p>
<script type="math/tex; mode=display">
\begin{aligned}
\widehat{Q}_{N+2}&=\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\frac{1_{\eta_1=0}}{1-q}\left(\widehat{P}\left(\overline{\mathbf{p}}_{3}\right)+\frac{1_{\eta_2=0}}{1-q}\left(\widehat{P}\left(\overline{\mathbf{p}}_{4}\right)+\cdots+\frac{1_{\eta_N=0}}{1-q}\sum_{n=N+2}^{\infty} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)\right)\right)\\
&=\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\frac{1_{\eta_1=0}}{1-q}\widehat{P}\left(\overline{\mathbf{p}}_{3}\right)+\frac{1_{\eta_1,\eta_2=0}}{(1-q)^2}\widehat{P}\left(\overline{\mathbf{p}}_{4}\right)+\cdots+\frac{1_{\eta_1,\eta_2,\cdots,\eta_N=0}}{(1-q)^N}\sum_{n=N+2}^{\infty} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)
\end{aligned}</script><p>是 <script type="math/tex">\sum\limits_{n=1}^{\infty}{P}\left(\overline{\mathbf{p}}_{n}\right)</script> 的无偏估计量．令 <script type="math/tex">\widehat{Q}=\lim\limits_{N\to\infty}\widehat{Q}_{N}</script>，则 $\widehat{Q}$ 也是无偏估计量．</p>
<p>设</p>
<script type="math/tex; mode=display">
\tau=\inf\{\:i\mid\eta_i=1\:\},</script><p>即第 $\tau+2$ 项及其后的所有项都被丢弃，我们可以将 $\widehat{Q}$ 写作</p>
<script type="math/tex; mode=display">
\widehat{Q}=\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\sum_{n=3}^{\tau+1}\frac{1}{(1-q)^{n-2}} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)=\sum_{n=1}^{2} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)+\sum_{n=3}^{\infty}\frac{1}{(1-q)^{n-2}} \widehat{P}\left(\overline{\mathbf{p}}_{n}\right)1_{\tau>n-2}.</script><p>不难求出，$\tau$ 服从几何分布，其概率质量函数为</p>
<script type="math/tex; mode=display">
\mathrm{P}(\tau=k)=(1-q)^{k-1} q,\quad k=1,2, \cdots.</script><p>于是，我们可以用计算验证 $\widehat{Q}$ 的无偏性</p>
<script type="math/tex; mode=display">
\begin{aligned}
\mathrm{E}\left[\widehat{Q}\right]&=\sum_{n=1}^{2} P\left(\overline{\mathbf{p}}_{n}\right)+\sum_{n=3}^{\infty}\frac{1}{(1-q)^{n-2}} P\left(\overline{\mathbf{p}}_{n}\right)\mathrm{P}(\tau>n-2)\\
&=\sum_{n=1}^{2} P\left(\overline{\mathbf{p}}_{n}\right)+\sum_{n=3}^{\infty}\frac{1}{(1-q)^{n-2}} P\left(\overline{\mathbf{p}}_{n}\right)\sum_{k=n-1}^{\infty}(1-q)^{k-1}q\\
&=\sum_{n=1}^{2} P\left(\overline{\mathbf{p}}_{n}\right)+\sum_{n=3}^{\infty}\frac{1}{(1-q)^{n-2}} P\left(\overline{\mathbf{p}}_{n}\right)(1-q)^{n-2}\\
&=\sum_{n=1}^{\infty} P\left(\overline{\mathbf{p}}_{n}\right).
\end{aligned}</script><p>注意到 $\mathrm{P}(\tau&lt;\infty)=1$，即 $\widehat{Q}$ 为有限项的概率为 $1$，我们完全可以在现实中求出 $\widehat{Q}$ 的估计值．</p>
<h2 id="伪代码"><a href="#伪代码" class="headerlink" title="伪代码"></a>伪代码</h2><p>路径追踪算法的伪代码如下：<br><div class="hljs"><pre><code class="hljs properties"><span class="hljs-meta">shade(p,</span> <span class="hljs-string">wo):</span>
<span class="hljs-comment">    # Contribution from the light source.</span>
    <span class="hljs-attr">uniformly</span> <span class="hljs-string">sample the light at x’ (pdf_light = 1 / A);</span>
    <span class="hljs-attr">shoot</span> <span class="hljs-string">a ray from p to x’;</span>
    <span class="hljs-attr">L_dir</span> = <span class="hljs-string">0.0;</span>
    <span class="hljs-attr">if</span> <span class="hljs-string">the ray is not blocked in the middle:</span>
        <span class="hljs-attr">L_dir</span> = <span class="hljs-string">L_i * f_r * cos θ * cos θ’ / |x’ - p|^2 / pdf_light;</span>

<span class="hljs-comment">    # Contribution from other reflectors.</span>
    <span class="hljs-attr">L_indir</span> = <span class="hljs-string">0.0;</span>
    <span class="hljs-attr">test</span> <span class="hljs-string">Russian Roulette with probability P_RR;</span>
    <span class="hljs-attr">if</span> <span class="hljs-string">passing Russian Roulette test:</span>
        <span class="hljs-attr">uniformly</span> <span class="hljs-string">sample the hemisphere toward wi (pdf_hemi = 1 / 2pi);</span>
        <span class="hljs-attr">trace</span> <span class="hljs-string">a ray r(p, wi);</span>
        <span class="hljs-attr">if</span> <span class="hljs-string">ray r hit a non-emitting object at q:</span>
            <span class="hljs-attr">L_indir</span> = <span class="hljs-string">shade(q, -wi) * f_r * cos θ / pdf_hemi / P_RR;</span>
    
    <span class="hljs-attr">return</span> <span class="hljs-string">L_dir + L_indir;</span></code></pre></div></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/cn/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2/">计算机图形</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/cn/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2/">计算机图形</a>
                    
                      <a class="hover-with-bg" href="/cn/tags/PBR/">PBR</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/cn/2020/11/22/Position%20Based%20Dynamics/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">基于位置的动力学</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/cn/2020/10/13/PBR%20-%20Surface%20Reflection/">
                        <span class="hidden-mobile">基于物理的渲染 - 表面反射</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "vjkw64ePz7yaH6jhWSQCKRQx-gzGzoHsz",
          app_key: "FnH9uRrc0O6C9Rc00UjmDqgl",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "",
        });
      });
    }
    waitElementVisible('vcomments', loadValine);
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">鄂ICP备19020559号-2</a>
    
  </div>


    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/cn/js/debouncer.js" ></script>
<script  src="/cn/js/main.js" ></script>

<!-- Plugins -->


  
    
      <script  src="/cn/js/lazyload.js" ></script>
    
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/cn/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/cn/js/to_en.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "路径追踪渲染算法&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "↩"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/cn/js/local-search.js" ></script>
  <script>
    var path = "/cn/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.2.0/es5/tex-svg.js" ></script>

  
















</body>
</html>
